/* Pentatype by Frosetrain */

// This line contains some Shakespeare quotes that I gathered
// Please ignore the fact that this line is 9512 characters long
// Fun fact: I had to remove the 35-line version of "to be or not to be"
// because it was too long and caused formatting issues
// prettier-ignore
collection = [[{"numLines":"1","source":"Soothsayer, Julius Caesar 1.2","quote":"Beware the Ides of March.\n"},{"numLines":"1","source":"Caesar, Julius Caesar 1.2","quote":"He is a dreamer; let us leave him: pass.\n"},{"numLines":"1","source":"Caesar, Julius Caesar 3.1","quote":"Et tu, Brute? Then fall, Caesar.\n"},{"numLines":"1","source":"Brutus, Julius Caesar 3.2","quote":"Not that I loved Caesar less, but that I loved Rome more.\n"},{"numLines":"1","source":"Antony, Julius Caesar 3.2","quote":"Friends, Romans, countrymen, lend me your ears.\n"},{"numLines":"1","source":"Macbeth, Macbeth 3.4","quote":"It will have blood; they say, blood will have blood.\n"},{"numLines":"1","source":"Lady Macbeth, Macbeth 5.1","quote":"What's done cannot be undone.\n"},{"numLines":"1","source":"Romeo, Romeo and Juliet 2.1","quote":"But, soft! what light through yonder window breaks?\n"},{"numLines":"1","source":"Juliet, Romet and Juliet 2.1","quote":"O Romeo, Romeo! wherefore art thou Romeo?\n"},{"numLines":"1","source":"Juliet, Romeo and Juliet 4.3","quote":"Romeo, I come! this do I drink to thee.\n"}],[{"numLines":"2","source":"Calpurnia, Julius Caesar 2.2","quote":"When beggars die, there are no comets seen;\nThe heavens themselves blaze forth the death of princes.\n"},{"numLines":"2","source":"Caesar, Julius Caesar 2.2","quote":"Cowards die many times before their deaths;\nThe valiant never taste of death but once.\n"},{"numLines":"2","source":"Cassius, Julius Caesar 5.3","quote":"Caesar, thou art revenged,\nEven with the sword that kill'd thee.\n"},{"numLines":"2","source":"Brutus, Julius Caesar 5.5","quote":"Caesar, now be still:\nI kill'd not thee with half so good a will.\n"},{"numLines":"2","source":"Octavius, Julius Caesar 5.5","quote":"So call the field to rest; and let's away,\nTo part the glories of this happy day.\n"},{"numLines":"2","source":"Witches, Macbeth 1.1","quote":"Fair is foul, and foul is fair:\nHover through the fog and filthy air.\n"},{"numLines":"2","source":"Macbeth, Macbeth 1.1","quote":"If it were done when 'tis done, then 'twere well\nIt were done quickly.\n"},{"numLines":"2","source":"Lady Macbeth, Macbeth 2.2","quote":"That which hath made them drunk hath made me bold;\nWhat hath quench'd them hath given me fire.\n"},{"numLines":"2","source":"Macbeth, Macbeth 2.2","quote":"Will all great Neptune's ocean wash this blood\nClean from my hand?\n"},{"numLines":"2","source":"Witches, Macbeth 4.1","quote":"Double, double toil and trouble;\nFire burn, and cauldron bubble.\n"},{"numLines":"2","source":"Second Witch, Macbeth 4.1","quote":"By the pricking of my thumbs,\nSomething wicked this way comes.\n"},{"numLines":"2","source":"Macbeth, Macbeth 5.7","quote":"Lay on, Macduff,\nAnd damn'd be him that first cries, 'Hold, enough!'\n"},{"numLines":"2","source":"Juliet, Romeo and Juliet 2.1","quote":"That which we call a rose\nBy any other name would smell as sweet;\n"},{"numLines":"2","source":"Romeo, Romeo and Juliet 5.3","quote":"O true apothecary!\nThy drugs are quick. Thus with a kiss I die.\n"}],[{"numLines":"3","source":"Cassius, Julius Caesar 1.2","quote":"Men at some time are masters of their fates.\nThe fault, dear Brutus, is not in our stars\nBut in ourselves, that we are underlings.\n"},{"numLines":"3","source":"Cassius, Julius Caesar 5.3","quote":"Come down, behold no more.\nO, coward that I am, to live so long,\nTo see my best friend ta'en before my face!\n"},{"numLines":"3","source":"Antony, Julius Caesar 5.5","quote":"His life was gentle, and the elements\nSo mix'd in him that Nature might stand up\nAnd say to all the world 'This was a man!'\n"},{"numLines":"3","source":"Macbeth, Macbeth 2.1","quote":"Is this a dagger which I see before me,\nThe handle toward my hand? Come, let me clutch thee.\nI have thee not, and yet I see thee still.\n"},{"numLines":"3","source":"Third Apparition, Macbeth 4.1","quote":"Macbeth shall never vanquish'd be until\nGreat Birnam wood to high Dunsinane hill\nShall come against him.\n"},{"numLines":"3","source":"Macduff, Macbeth 5.7","quote":"And let the angel whom thou still hast served\nTell thee, Macduff was from his mother's womb\nUntimely ripp'd.\n"},{"numLines":"3","source":"Juliet, Romeo and Juliet 5.3","quote":"O happy dagger!\nThis is thy sheath;\nthere rust, and let me die.\n"},{"numLines":"4","source":"Cassius, Julius Caesar 1.2","quote":"Why, man, he doth bestride the narrow world\nLike a Colossus, and we petty men\nWalk under his huge legs and peep about\nTo find ourselves dishonourable graves.\n"},{"numLines":"4","source":"Lady Macbeth, Macbeth 1.5","quote":"Come, you spirits\nThat tend on mortal thoughts, unsex me here,\nAnd fill me from the crown to the toe top-full\nOf direst cruelty!\n"},{"numLines":"4","source":"Juliet, Romet and Juliet 2.1","quote":"O Romeo, Romeo! wherefore art thou Romeo?\nDeny thy father and refuse thy name;\nOr, if thou wilt not, be but sworn my love,\nAnd I'll no longer be a Capulet.\n"},{"numLines":"5","source":"Flavius, Julius Caesar 1.1","quote":"Hence! home, you idle creatures get you home:\nIs this a holiday? what! know you not,\nBeing mechanical, you ought not walk\nUpon a labouring day without the sign\nOf your profession? Speak, what trade art thou?\n"},{"numLines":"5","source":"Antony, Julius Caesar 3.2","quote":"Friends, Romans, countrymen, lend me your ears;\nI come to bury Caesar, not to praise him.\nThe evil that men do lives after them;\nThe good is oft interred with their bones;\nSo let it be with Caesar. \n"},{"numLines":"5","source":"Hamlet, Hamlet 3.1","quote":"To be, or not to be, that is the question,\nWhether 'tis nobler in the mind to suffer\nThe slings and arrows of outrageous fortune,\nOr to take arms against a sea of troubles,\nAnd by opposing end them? To die: to sleep.\n"},{"numLines":"5","source":"Romeo, Romeo and Juliet 2.1","quote":"But, soft! what light through yonder window breaks?\nIt is the east, and Juliet is the sun.\nArise, fair sun, and kill the envious moon,\nWho is already sick and pale with grief,\nThat thou her maid art far more fair than she.\n"},{"numLines":"6","source":"Caesar, Julius Caesar 2.2","quote":"Cowards die many times before their deaths;\nThe valiant never taste of death but once.\nOf all the wonders that I yet have heard.\nIt seems to me most strange that men should fear;\nSeeing that death, a necessary end,\nWill come when it will come.\n"},{"numLines":"6","source":"Macbeth, Macbeth 2.2","quote":"Methought I heard a voice cry 'Sleep no more!\nMacbeth does murder sleep', the innocent sleep,\nSleep that knits up the ravell'd sleeve of care,\nThe death of each day's life, sore labour's bath,\nBalm of hurt minds, great nature's second course,\nChief nourisher in life's feast.\n"},{"numLines":"7","source":"Cassius, Julius Caesar 1.2","quote":"Why, man, he doth bestride the narrow world\nLike a Colossus, and we petty men\nWalk under his huge legs and peep about\nTo find ourselves dishonourable graves.\nMen at some time are masters of their fates:\nThe fault, dear Brutus, is not in our stars,\nBut in ourselves, that we are underlings.\n"},{"numLines":"8","source":"Witches, Macbeth 1.1","quote":"When shall we three meet again?\nIn thunder, lightning, or in rain?\nWhen the hurly-burly's done,\nWhen the battle's lost and won.\nThat will be ere the set of sun.\nWhere the place?\nUpon the heath.\nThere to meet with Macbeth.\n"}],[{"numLines":"14","source":"Romeo and Juliet, Prologue","quote":"Two households, both alike in dignity,\nIn fair Verona, where we lay our scene,\nFrom ancient grudge break to new mutiny,\nWhere civil blood makes civil hands unclean.\nFrom forth the fatal loins of these two foes\nA pair of star-cross'd lovers take their life;\nWhose misadventured piteous overthrows\nDo with their death bury their parents' strife.\nThe fearful passage of their death-mark'd love,\nAnd the continuance of their parents' rage,\nWhich, but their children's end, nought could remove,\nIs now the two hours' traffic of our stage;\nThe which if you with patient ears attend,\nWhat here shall miss, our toil shall strive to mend.\n"},{"numLines":"14","source":"Sonnet 18","quote":"Shall I compare thee to a summer's day?\nThou art more lovely and more temperate:\nRough winds do shake the darling buds of May,\nAnd summer's lease hath all too short a date;\nSometime too hot the eye of heaven shines,\nAnd often is his gold complexion dimm'd;\nAnd every fair from fair sometime declines,\nBy chance or nature's changing course untrimm'd;\nBut thy eternal summer shall not fade,\nNor lose possession of that fair thou ow'st;\nNor shall death brag thou wander'st in his shade,\nWhen in eternal lines to time thou grow'st:\nSo long as men can breathe or eyes can see,\nSo long lives this, and this gives life to thee.\n"},{"numLines":"15","source":"Lady Macbeth, Macbeth 1.5","quote":"Come, you spirits\nThat tend on mortal thoughts, unsex me here,\nAnd fill me from the crown to the toe top-full\nOf direst cruelty! make thick my blood;\nStop up the access and passage to remorse,\nThat no compunctious visitings of nature\nShake my fell purpose, nor keep peace between\nThe effect and it! Come to my woman's breasts,\nAnd take my milk for gall, you murdering ministers,\nWherever in your sightless substances\nYou wait on nature's mischief! Come, thick night,\nAnd pall thee in the dunnest smoke of hell,\nThat my keen knife see not the wound it makes,\nNor heaven peep through the blanket of the dark,\nTo cry 'Hold, hold!'\n"}]]

let currentLine;
let currentChar;
let typed;
let quote;
let sourceBox;
let source;
let otherLines;
let lines;
let quoteLength;
let hintBox;
let lineId;
let currentLineBox;
let otherLinesBox;
let selectionDiv;
let theme;
let timeStart;
let isTyping;
let isDone;
let keypresses;
let previousLines;
let quoteType = 0;

const lineLabels = ["1", "2", "3-8", "9+"];
const lineSetters = [];

// Creating functions in a for loop!
// This is a bit of a javascript W
for (let i = 0; i < 4; i++) {
    const setter = function () {
        for (let j = 0; j < 4; j++) {
            otherButton = document.getElementById("lineSetter" + str(j));
            otherButton.classList.remove("bg-accent-400", "dark:bg-accent-600");
            otherButton.classList.add("bg-gray-300", "dark:bg-gray-700");
        }
        button = document.getElementById("lineSetter" + str(i));
        button.classList.remove("bg-gray-300", "dark:bg-gray-700");
        button.classList.add("bg-accent-400", "dark:bg-accent-600");
        quoteType = i;
        applyQuote();
        currentLineBox.html(
            "<span class=text-accent-500>> </span>" + currentLine
        );
        sourceBox.html(source);
    };
    lineSetters.push(setter);
}

function no() {}

function getRandomQuote(category) {
    /* Get a random quote from the collection.
    
    Categories are:
    0: monostitches (1 line)
    1: couplets (2 lines)
    2: 3 to 8 lines
    3: insanely long quotes (9 lines and above)
    */
    return collection[category][
        Math.floor(Math.random() * collection[category].length)
    ];
}

function landingPage() {
    /* Draw a landing page.
    quite obvious
    */
    removeElements();
    createCanvas(windowWidth, windowHeight - 60);
    bigDiv = createDiv();
    bigDiv.class(
        "flex flex-col w-screen items-center justify-center overflow-hidden"
    );
    bigDiv.style("height", windowHeight - 60 + "px");
    bigDiv.position(0, 60);
    selectionDiv = createDiv();
    selectionDiv.class(
        "m-4 flex justify-center rounded bg-gray-200 p-2 text-gray-900 dark:bg-gray-800 dark:text-gray-100"
    );
    selectionDiv.parent(bigDiv);
    selectionDiv.id("selectionDiv");
    lineSelectDiv = createDiv();
    lineSelectDiv.parent(selectionDiv);
    lineSelectDiv.class("mx-4 flex");
    linesLabel = createElement("p", "Lines");
    linesLabel.parent(lineSelectDiv);
    linesLabel.class("px-2");
    for (let i = 0; i < 4; i++) {
        btn = createButton(lineLabels[i]);
        btn.parent(lineSelectDiv);
        btn.class(
            "mx-0.5 rounded bg-gray-300 px-2 transition duration-200 ease-in-out hover:bg-accent-300 dark:bg-gray-700 dark:hover:bg-accent-700"
        );
        btn.id("lineSetter" + str(i));
        btn.mousePressed(lineSetters[i]);
    }

    statsDiv = createDiv();
    statsDiv.parent(bigDiv);
    statsDiv.class("flex w-full px-8");
    timeBox = createElement("p", "0.0");
    timeBox.parent(statsDiv);
    timeBox.class("font-mono pr-4 text-gray-900 dark:text-gray-100");
    // progress bar
    progressDiv = createDiv();
    progressDiv.parent(statsDiv);
    progressDiv.class(
        "h-2.5 my-auto w-full rounded-full bg-gray-200 dark:bg-gray-700"
    );
    progressBar = createDiv();
    progressBar.parent(progressDiv);
    progressBar.class("h-2.5 rounded-full bg-accent-600");
    progressBar.style("width", "0%");
    statsDiv.hide();

    typingDiv = createDiv();
    typingDiv.parent(bigDiv);
    typingDiv.class("m-8");

    currentLineBox = createElement(
        "p",
        "<span class=text-accent-500>> </span>" + currentLine
    );
    currentLineBox.parent(typingDiv);
    currentLineBox.class(
        "p-2 my-2 rounded text-center text-xl font-mono text-gray-400 dark:text-gray-500 bg-gray-200 dark:bg-gray-800"
    );
    otherLinesBox = createElement("p", "...");
    otherLinesBox.parent(typingDiv);
    otherLinesBox.class(
        "whitespace-pre-line my-2 text-center text-md font-mono text-gray-400 dark:text-gray-600"
    );
    sourceBox = createElement("p", "- " + source);
    sourceBox.parent(typingDiv);
    sourceBox.class("py-4 text-right italic text-gray-500");

    hintBox = createElement("p", "Press Control to get a new quote");
    hintBox.parent(bigDiv);
    hintBox.class("text-gray-600 dark:text-gray-400 font-bold ");
}

function startTyping() {
    selectionDiv.hide();
    statsDiv.style("display", "flex");
    hintBox.hide();
    otherLinesBox.html(otherLines);
}

function applyQuote() {
    let got = getRandomQuote(quoteType);
    quote = got["quote"];
    source = got["source"];
    otherLines = quote.substring(quote.indexOf("\n") + 1);
    if (quote[quote.length - 1] == "\n") {
        quote = quote.substring(0, quote.length - 1);
    }
    lines = quote.split("\n");
    currentLine = lines[0];
    quoteLength = lines.length;
}

function resetVars() {
    lineId = 0;
    currentChar = 0;
    typed = "";
    previousLines = 0;
    isTyping = false;
    isDone = false;
    keypresses = 0;
}

function setup() {
    resetVars();
    applyQuote();
    landingPage();
    lineSetters[quoteType]();
    frameRate(10);
}

function windowResized() {
    // drawUI();
}

function showTyping() {
    let firstError = currentChar;
    for (let i = 0; i < typed.length; i++) {
        if (typed[i] != currentLine[i]) {
            firstError = i;
            break;
        }
    }
    currentLineBox.html(
        "<span class=text-accent-500>> </span>" +
            "<span class='text-gray-900 dark:text-gray-100'>" +
            typed.substring(0, firstError) + // white
            "</span><span class='text-red-500'>" +
            typed.substring(firstError, currentChar) + // red
            "</span>" +
            currentLine.substring(currentChar, currentLine.length) // gray
    );
}

function success(timeTaken) {
    isDone = true;
    isTyping = false;
    // removeElements();
    selectionDiv.hide();
    statsDiv.hide();
    typingDiv.hide();
    let wpm = ((quote.length / timeTaken) * 60000) / 6;
    let accuracy = (quote.length / keypresses) * 100;
    successDiv = createDiv();
    successDiv.parent(bigDiv);
    successDiv.class("text-center");
    finishBox = createElement("p", "Thou art finish'd");
    finishBox.class("text-gray-900 dark:text-gray-100 font-bold text-2xl py-2");
    finishBox.parent(successDiv);
    wpmDiv = createDiv();
    wpmDiv.class("flex my-2 items-center justify-center");
    wpmDiv.parent(successDiv);
    wpmLabel = createElement("p", "WPM");
    wpmLabel.parent(wpmDiv);
    wpmLabel.class("text-gray-900 dark:text-gray-100");
    wpmBox = createElement("p", round(wpm));
    wpmBox.parent(wpmDiv);
    wpmBox.class(
        "text-gray-900 dark:text-gray-100 font-mono mx-2 px-1 bg-gray-300 dark:bg-gray-700 rounded"
    );
    accDiv = createDiv();
    accDiv.class("flex my-2 items-center justify-center");
    accDiv.parent(successDiv);
    accLabel = createElement("p", "Accuracy");
    accLabel.parent(accDiv);
    accLabel.class("text-gray-900 dark:text-gray-100");
    accBox = createElement("p", round(accuracy));
    accBox.parent(accDiv);
    accBox.class(
        "text-gray-900 dark:text-gray-100 font-mono mx-2 px-1 bg-gray-300 dark:bg-gray-700 rounded"
    );
    retryButton = createButton("Reattempt");
    retryButton.parent(successDiv);
    retryButton.class(
        "rounded bg-accent-300 dark:bg-accent-700 dark:text-gray-100 text-gray-900 my-4 p-2 transition duration-200 ease-in-out hover:bg-accent-300"
    );
    retryButton.mousePressed(restart);
}

function restart() {
    if (isDone) {
        setup();
        lineSetters[quoteType]();
    }
    resetVars();
    selectionDiv.style("display", "flex");
    hintBox.show();
    applyQuote();
    currentLineBox.html("<span class=text-accent-500>> </span>" + currentLine);
    otherLinesBox.html("...");
    sourceBox.html(source);
    statsDiv.hide();
}

function keyPressed() {
    if (keyCode == BACKSPACE && currentChar > 0) {
        typed = typed.substring(0, typed.length - 1);
        currentChar--;
        showTyping();
    }
    if (keyCode == CONTROL) {
        restart();
    }
    if (![20, 8, 17, 46, 13, 9, 27, 16, 18, 38, 40, 37, 39].includes(keyCode)) {
        keypresses++;
        if (currentChar == 0 && lineId == 0) {
            isTyping = true;
            timeStart = Date.now();
            startTyping();
        }
        typed += key;
        currentChar++;
        showTyping();
        if (typed == currentLine) {
            if (lineId == quoteLength - 1) {
                success(Date.now() - timeStart);
            }
            previousLines += currentLine.length;
            lineId++;
            lines.shift();
            currentLine = lines[0];
            typed = "";
            currentChar = 0;
            indexOfNewline = otherLines.indexOf("\n");
            if (indexOfNewline == -1) {
                otherLines = "";
            } else {
                otherLines = otherLines.substring(otherLines.indexOf("\n") + 1);
            }
            currentLineBox.html(
                "<span class=text-accent-500>> </span>" + currentLine
            );
            otherLinesBox.html(otherLines);
        }
    }
    progress = ((typed.length + previousLines) / quote.length) * 100;
    progressBar.style("width", progress + "%");
}

function draw() {
    if (isTyping) {
        timeBox.html(((Date.now() - timeStart) / 1000).toFixed(1));
    }
    // fill("black");
    // rect(100, 80, 20, 20);
    // fill("white");
    // textSize(20);
    // text(currentChar, 100, 100);
    // newTheme = localStorage.theme;
    // if (theme != newTheme) {
    // background(gray[newTheme]["bg"]);
    // theme = newTheme;
    // }
}
